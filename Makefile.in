# compiler flags 
CC=@CC@
CFLAGS=@CFLAGS@ -ansi -pedantic -Wall

# postgresql ... required
POSTGIS_INC=@POSTGIS_INC@
POSTGIS_LIB=@POSTGIS_LIB@
PGFLAGS=$(POSTGIS_INC) $(POSTGIS_LIB)
# libxml2 ... required
XML2_INC=@XML2_INC@
XML2_LIB=@XML2_LIB@
XMLFLAGS=$(XML2_INC) $(XML2_LIB)

# fast-cgi ... optional
FCGI_INC=@FCGI_INC@
FCGI_LIB=@FCGI_LIB@
FCGIFLAGS=$(FCGI_INC) $(FCGI_LIB)

# install path
PREFIX=@prefix@

# Revision number if subversion there
SVN_FLAGS=@SVN_FLAGS@

SRC=src/fe/fe_comparison_ops.c src/fe/fe_error.c src/fe/fe_filter.c src/fe/fe_filter_capabilities.c src/fe/fe_function.c src/fe/fe_logical_ops.c src/fe/fe_spatial_ops.c src/mapfile/mapfile.c src/ows/ows_bbox.c src/ows/ows.c src/ows/ows_config.c src/ows/ows_error.c src/ows/ows_geobbox.c src/ows/ows_get_capabilities.c src/ows/ows_layer.c src/ows/ows_metadata.c src/ows/ows_psql.c src/ows/ows_request.c src/ows/ows_srs.c src/ows/ows_storage.c src/ows/ows_version.c src/struct/alist.c src/struct/array.c src/struct/buffer.c src/struct/cgi_request.c src/struct/list.c src/struct/mlist.c src/struct/regexp.c src/wfs/wfs_describe.c src/wfs/wfs_error.c src/wfs/wfs_get_capabilities.c src/wfs/wfs_get_feature.c src/wfs/wfs_request.c src/wfs/wfs_transaction.c 

all:
	lex -i -o src/mapfile/mapfile.c src/mapfile/mapfile.l
	$(CC) $(CFLAGS) $(PGFLAGS) $(XMLFLAGS) $(FCGIFLAGS) $(SVN_FLAGS) $(SRC) -o tinyows -L/usr/lib -lfl
	@rm -rf tinyows.dSYM

svn-clean: clean doc-clean 
	@find . -name '*~' -exec rm {} \;	
	@rm -f configure

clean: 
	@rm -f tinyows Makefile src/ows_define.h
	@rm -rf tinyows.dSYM
	@rm -f src/mapfile/mapfile.c
	@rm -f demo/config.xml demo/install.sh
	@rm -f test/config.xml test/install.sh

install:
	@echo "-----"
	@echo "TinyOWS Schema install dir in $(PREFIX)/tinyows/schema"
	mkdir -p $(PREFIX)/tinyows
	rm -rf $(PREFIX)/tinyows/schema
	cp -rf schema $(PREFIX)/tinyows/
	@echo "-----"
	@echo "Now:"
	@echo " 1) copy 'tinyows' binary to cgi-bin directory"
	@echo " 2) - put a workable config.xml file in $(PREFIX) dir"
	@echo "    - OR launch 'make install-demo' as a superuser"

install-demo:
	@chmod +x demo/install.sh
	@demo/install.sh
	cp -i demo/config.xml $(PREFIX)/tinyows

install-test:
	@chmod +x test/install.sh
	@test/install.sh
	cp -i test/config.xml $(PREFIX)/tinyows

doc-clean:
	@rm -rf doc/doxygen

doxygen: doc-clean
	@(which doxygen 2> /dev/null > /dev/null	\
	&& mkdir -p doc/doxygen				\
	&& doxygen doc/Doxyfile				\
	) || echo "doxygen seems not installed"

test-valgrind:
	@test/unit_test test/wfs/cite_wfs_1_1_0-sf0 1

test-output:
	@test/unit_test test/wfs/cite_wfs_1_1_0-sf0 4

test-http:
	@test/unit_test test/wfs/cite_wfs_1_1_0-sf0 5

test-exception:
	@test/unit_test test/wfs/cite_wfs_1_1_0-sf0 6

test-stderr:
	@test/unit_test test/wfs/cite_wfs_1_1_0-sf0 7
