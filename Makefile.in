# compiler flags 
CC=@CC@
CFLAGS=@CFLAGS@ -ansi -pedantic -Wall

# postgresql ... required
POSTGIS_INC=@POSTGIS_INC@
POSTGIS_LIB=@POSTGIS_LIB@
PGFLAGS=$(POSTGIS_INC) $(POSTGIS_LIB)
# libxml2 ... required
XML2_INC=@XML2_INC@
XML2_LIB=@XML2_LIB@
XMLFLAGS=$(XML2_INC) $(XML2_LIB)
# install path
PREFIX=@prefix@

SRC = $(wildcard src/*/*.c)

all:
	$(CC) $(CFLAGS) $(PGFLAGS) $(XMLFLAGS) $(SRC) -o tinyows
	@rm -rf tinyows.dSYM

svn-clean: clean doc-clean
	@find . -name '*~' -exec rm {} \;
	@rm -f configure

clean: 
	@rm -f tinyows Makefile src/ows_define.h
	@rm -rf tinyows.dSYM

install:
	mkdir -p $(PREFIX)/tinyows
	cp tinyows $(PREFIX)/tinyows/
	cp -rf schema $(PREFIX)/tinyows/
	cp -i config.xml $(PREFIX)/tinyows/

doc-clean:
	@rm -rf doc/doxygen

doxygen: doc-clean
	@(which doxygen 2> /dev/null > /dev/null	\
	&& mkdir -p doc/doxygen				\
	&& doxygen doc/Doxyfile				\
	) || echo "doxygen seems not installed"

test-valgrind:
	@test/unit_test test/wfs/get_feature 1
	@test/unit_test test/wfs/get_feature/spatialops 1
	@test/unit_test test/wfs/get_feature/logicalops 1
	@test/unit_test test/wfs/get_feature/gmlsf-1 1
	@test/unit_test test/wfs/get_feature/arithmeticops 1
	@test/unit_test test/wfs/get_capabilities 1
	@test/unit_test test/wfs/describe 1

test-output:
	@test/unit_test test/wfs/get_feature 3
	@test/unit_test test/wfs/get_feature/spatialops 3
	@test/unit_test test/wfs/get_feature/logicalops 3
	@test/unit_test test/wfs/get_feature/gmlsf-1 3
	@test/unit_test test/wfs/get_feature/arithmeticops 3
	@test/unit_test test/wfs/get_capabilities 3
	@test/unit_test test/wfs/describe 3

test-exception:
	@test/unit_test test/wfs/get_feature 4
	@test/unit_test test/wfs/get_feature/spatialops 4
	@test/unit_test test/wfs/get_feature/logicalops 4
	@test/unit_test test/wfs/get_feature/gmlsf-1 4
	@test/unit_test test/wfs/get_feature/arithmeticops 4
	@test/unit_test test/wfs/get_capabilities 4
	@test/unit_test test/wfs/describe 4

indent:
	@(which indent 2> /dev/null > /dev/null \
	&& indent -nbad -bap -bbo -nbc -bli0 -c33 -cd33 -ncdb -nce -nlp -ci3 -cli0 -cp33 -cs -d0 -di1 -nfc1 -nfca -hnl -ts4 -i4 -ip0 -npcs -nprs -npsl -saf -sai -saw -nsc -nsob -nss -nbfda -nbfde -npsl -l75 $(SRC) \
	&& find . -name '*~' -exec rm {} \;    \
	) || echo "indent seems not installed"
